name: Set BizKit project dates on issue created

on:
  repository_dispatch:
    types: [project-item-created]

jobs:
  set-dates:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Get today
        id: today
        env:
          TZ: Asia/Seoul
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set start_at
        uses: nipe0324/update-project-v2-item-field@v2.0.2
        with:
          project-url: https://github.com/orgs/100-hours-a-week/projects/281
          github-token: ${{ secrets.UPDATE_PROJECT_V2_PAT }}
          all-items: true
          skip-update-script: |
            const isIssue = item.type === 'ISSUE'
            const issueNumber = item.content?.number
            const targetNumber = context.payload.client_payload.number
            const hasStart = !!item.fieldValues['start_at']
            return !isIssue || issueNumber !== targetNumber || hasStart
          field-name: "start_at"
          field-value: "${{ steps.today.outputs.date }}"

      - name: Set end_at
        uses: nipe0324/update-project-v2-item-field@v2.0.2
        with:
          project-url: https://github.com/orgs/100-hours-a-week/projects/281
          github-token: ${{ secrets.UPDATE_PROJECT_V2_PAT }}
          all-items: true
          skip-update-script: |
            const isIssue = item.type === 'ISSUE'
            const issueNumber = item.content?.number
            const targetNumber = context.payload.client_payload.number
            const hasEnd = !!item.fieldValues['end_at']
            return !isIssue || issueNumber !== targetNumber || hasEnd
          field-name: "end_at"
          field-value: "${{ steps.today.outputs.date }}"